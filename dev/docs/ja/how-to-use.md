# 使い方

## APIキーの設定

AIのAPIキーを設定するには、```APIキーを聞く``` もしくは ```APIキーを( )にする``` ブロックを使用します。一度APIキーを入力すると、Scratchを終了するまで利用できます。

APIキーは、Gemini proのAPIキーを指定します。APIキーは、Gemini proのウェブサイトで取得できます。<br>[API キーを取得する  \|  Google AI for Developers](https://ai.google.dev/tutorials/setup?hl=ja)

```APIキーを聞く``` ブロックは、APIキーを入力するためのダイアログを表示します。

```APIキーを( )にする``` ブロックは、AIのAPIキーを設定します。あらかじめキーを入力した ```APIキーを( )にする``` ブロックをコードエリアに置くことで、APIキーをプロジェクトに保存することができます。

```APIキー``` は、現在設定されているAPIキーを一部分にマスクを掛けて取得します。


## AIへの問い合わせ

AIへの問い合わせは、```単独の生成(プロンプト)```、```対話(プロンプト)``` ブロックを使用して行います。

```単独の生成(プロンプト)``` は、AIに ```(プロンプト)``` を送り、AIがそれに続く文章を生成するのを待ちます。

```対話(プロンプト)``` は、AIに以前の対話の続きとして ```(プロンプト)``` を送り、AIがその対話に続く文章を生成するのを待ちます。このブロックを続けて実行することで、自動的に対話を積み重ねていくことができます。

これまで行った対話は、```対話履歴``` ブロックで取得でき、それを ```( )に続けて対話を始める``` ブロックに入れると、その続きとして対話を始めることができます。

AIからの回答は、```回答候補(候補番号)``` で取得できます。```(候補番号)``` でAIが生成した文章の候補の番号を指定します。このブロックは、次にそのスプライトで ```単独の生成(プロンプト)``` もしくは ```対話(プロンプト)``` ブロックが実行されるまで回答を保持します。


```回答の一部を受け取ったとき``` ブロックがコードエリアで利用されているときは、完全な回答が返る前に部分的に送られた回答を ```回答の一部``` ブロックで取得できます。

生成に利用するモデルを指定するには、```単独の生成(プロンプト)``` もしくは ```対話(プロンプト)``` ブロックを実行する前に ```生成のモデルに(モデル名)を使う``` ブロックを使用します。```(モデル名)``` には、[Geminiのモデル名](https://ai.google.dev/gemini-api/docs/models/gemini?hl=ja)にある生成モデルのモデルコードを指定します。


## 関数呼び出し（Function Calls）

AIが関数呼び出し（Function Calls）を使って、Scratchプロジェクト内のカスタム関数を実行することができます。これにより、AIが単純なテキスト生成だけでなく、プロジェクトの状態を調べたり、スプライトを操作したりすることが可能になります。

### 関数の定義

AIが呼び出せる関数は、Scratchの「ブロックを作る」機能を使って自由に定義できます。
AIは関数の名前と引数の名前、それらにつけられたコメントを元に、関数の動作を理解します。
定義されたすべてのユーザー定義ブロックが、AIが呼び出せる関数として認識されます。
以下の手順で関数を定義できます。

1. 「ブロックを作る」でカスタムブロックを作成します
2. ブロック名と引数を設定します
3. ブロックの動作をScratchのブロックで実装します

名前だけではAIが関数の動作を理解できないときは、以下の手順でブロック定義と引数に説明を追加します。

   1. ブロック定義にコメントを追加して、関数の機能を説明します
   2. ブロックの引数をコードエリアに出して、引数にコメントを追加して、引数の役割を説明します

### 関数の結果を返す

AIが関数を呼び出した後、その結果をAIに返すには ```AIに結果(結果)を返す``` ブロックを使用します。これにより、AIは関数の実行結果を受け取って、次の処理を決定できます。

### 関数呼び出しの制御

```関数呼び出しを(設定)``` ブロックで、AIの関数呼び出し動作を設定できます。

```(設定)``` には、以下の指定ができます。
- ```使う``` - AIが必要に応じて関数を呼び出す（デフォルト）
- ```いつも使う``` - AIに関数呼び出しを強制する
- ```使わない``` - 関数呼び出しを無効にする

### 動作の流れ

1. AIがプロンプトを受け取る
2. 必要に応じて登録された関数を呼び出す
3. 関数の実行結果を受け取る
4. 結果を元に適切な回答を生成する

この機能により、AIがより動的で知的なScratchプロジェクトを作成できるようになります。


## 画像の利用

```単独の生成(プロンプト)``` に ```dataURL``` を使って画像のData URL形式のデータを含む文章を入れて問い合わせることができます。

_※ 現在公開されているGemini pro API v1では対話に画像を利用できません。_

Scratch内の画像の ```dataURL``` は、以下のブロックを使って取得することができます。

- ```コスチューム(セレクター)のデータ``` ブロックは、指定されたコスチュームの ```dataURL``` を取得します。```(セレクター)``` には、コスチュームの名前もしくは番号(- は最後からの順番)を指定できます。
- ```バックドロップ(セレクター)のデータ``` ブロックは、背景の ```dataURL``` を取得します。```(セレクター)``` には、背景の名前もしくは番号(- は最後からの順番)を指定できます。
- ```スナップショットのデータ``` ブロックは、ステージと表示されているスプライトのスナップショット画像の ```dataURL``` を取得します。


## 安全性の設定

```(安全性カテゴリ)の(設定レベル)``` ブロックによって、AIの生成結果の安全性を設定できます。

```(安全性カテゴリ)``` には、以下の指定ができます。

- ```すべての危険な内容```
- ```ヘイトスピーチ```
- ```露骨な性的表現```
- ```ハラスメント```
- ```危険な内容```

```(設定レベル)``` には、以下の指定ができます。

- ```設定をしない```
- ```ほとんどブロックする```
- ```一部をブロックする```
- ```少しをブロックする```
- ```ブロックしない```


## 生成パラメータの設定

AIが利用する生成モデルのパラメータの設定は、スプライト毎に別々に設定できます。

パラメータの設定は、```生成の(パラメータ)を( )にする``` ブロックを使用します。

```(パラメータ)```には、以下の指定ができます。

- ```温度```
- ```Top P```
- ```Top K```
- ```最大トークン数```
- ```回答候補の数```
- ```ストップシーケンス```
- ```システム インストラクション```
- ```レスポンス スキーマ```

```( )``` には、設定する値を指定します。

```生成の(パラメータ)``` ブロックは、そのスプライトの利用する生成モデルのパラメータを取得します。


## 埋め込み表現

```( )の(タスクタイプ)の埋め込み表現``` ブロックは、入力された文に対して指定されたタスクタイプの埋め込み表現を取得します。

```(タスクタイプ)``` は、以下の指定ができます。

- ```検索の質問として``` は、検索の質問として利用できる埋め込み表現をAIから取得します。
- ```検索対象の文章として``` は、検索対象の文章として利用できる埋め込み表現をAIから取得します。
- ```似た意味を探すため``` は、似た意味を探すための埋め込み表現をAIから取得します。
- ```分類のため``` は、分類のための埋め込み表現をAIから取得します。
- ```クラスタリングのため``` は、クラスタリングのための埋め込み表現をAIから取得します。

埋め込み表現は、```(ベクトルA)と(ベクトルB)の(計算方法)``` ブロックを使って類似度を計算することができます。ベクトルAとベクトルBは、```( )の(タスクタイプ)の埋め込み表現``` ブロックで取得した埋め込み表現を指定します。

 ```(計算方法)``` には、```内積``` もしくは ```ユークリッド距離``` を指定できます。

埋め込み表現に利用するモデルを指定するには、```( )の(タスクタイプ)の埋め込み表現``` ブロックを実行する前に ```埋め込み表現のモデルに(モデル名)を使う``` ブロックを使用します。```(モデル名)``` には、[Geminiのモデル名](https://ai.google.dev/gemini-api/docs/models/gemini?hl=ja)にあるテキストエンベッディングのモデルコードを指定します。
