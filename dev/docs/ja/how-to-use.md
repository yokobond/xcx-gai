# 使い方

## APIキーの設定

AIのAPIキーを設定するには、```APIキーを聞く``` もしくは ```APIキーを( )にする``` ブロックを使用します。一度APIキーを入力すると、Scratchを終了するまで利用できます。

APIキーは、Gemini proのAPIキーを指定します。APIキーは、Gemini proのウェブサイトで取得できます。<br>[API キーを取得する  \|  Google AI for Developers](https://ai.google.dev/tutorials/setup?hl=ja)

```APIキーを聞く``` ブロックは、APIキーを入力するためのダイアログを表示します。

```APIキーを( )にする``` ブロックは、AIのAPIキーを設定します。あらかじめキーを入力した ```APIキーを( )にする``` ブロックをコードエリアに置くことで、APIキーをプロジェクトに保存することができます。

```APIキー``` は、現在設定されているAPIキーを一部分にマスクを掛けて取得します。


## AIへの問い合わせ

AIへの問い合わせは、```生成(プロンプト)```、```チャット(プロンプト)``` ブロックを使用して行います。

```生成(プロンプト)``` は、AIに ```(プロンプト)``` を送り、AIがそれに続く文章を生成するのを待ちます。

```チャット(プロンプト)``` は、AIに以前のチャットの続きとして ```(プロンプト)``` を送り、AIがそのチャットに続く文章を生成するのを待ちます。このブロックを続けて実行することで、自動的にチャットを積み重ねていくことができます。

これまで行ったチャットは、```チャットの履歴``` ブロックで取得でき、それを ```( )に続けてチャットを始める``` ブロックに入れると、その続きとしてチャットを始めることができます。

AIからの回答は、```回答文``` で取得できます。このブロックは、次にそのスプライトで ```生成(プロンプト)``` もしくは ```チャット(プロンプト)``` ブロックが実行されるまで回答を保持します。

```回答の一部を受け取ったとき``` ブロックがコードエリアで利用されているときは、完全な回答が返る前に部分的に送られた回答を ```回答の一部``` ブロックで取得できます。


## モデル管理

AIプロバイダーが提供するモデルの情報を取得・管理するために、以下のブロックが利用できます。

### モデルの指定

生成に利用するモデルを指定するには、```生成(プロンプト)``` もしくは ```チャット(プロンプト)``` ブロックを実行する前に ```モデルに(モデル名)を使う``` ブロックを使用します。```(モデル名)``` には、使用するAIプロバイダーで利用可能なモデルのモデルコードを指定します。

### モデル情報の取得

- ```モデル``` ブロックは、現在指定されているモデルIDを取得します。これにより、どのモデルが使用されているかを確認できます。

- ```モデルの数``` ブロックは、現在のAIプロバイダーに問い合わせて得られる利用可能なモデルの総数を返します。この情報を使って、利用可能なモデルの範囲を知ることができます。

- ```モデルの(番号)番目のID``` ブロックは、プロバイダーに問い合わせて得た利用可能なモデルのリストから、指定した番号（1から開始）のモデルIDを取得します。この機能を使って、利用可能なすべてのモデルを順次取得できます。

### 使用例

利用可能なすべてのモデルを一覧表示する場合：

1. ```モデルの数``` ブロックで総数を取得
2. 1から総数まで繰り返して ```モデルの(番号)番目のID``` ブロックを実行
3. 各モデルIDを表示またはリストに保存

現在使用中のモデルを確認する場合：

- ```モデル``` ブロックを実行して、現在設定されているモデルIDを表示

### 注意事項

- モデル一覧の取得には、AIプロバイダーとの通信が必要な場合があります
- プロバイダーによっては、```モデルの数``` や ```モデルの(番号)番目のID``` ブロックを使用する前に、事前にAPIキーを設定する必要があります
- プロバイダーによって利用可能なモデルは異なります
- モデル番号は1から始まります（0ではありません）


## 関数呼び出し（Function Calls）

AIが関数呼び出し（Function Calls）を使って、Scratchプロジェクト内のカスタム関数を実行することができます。これにより、AIが単純なテキスト生成だけでなく、プロジェクトの状態を調べたり、スプライトを操作したりすることが可能になります。

### 関数の定義

AIが呼び出せる関数は、Scratchの「ブロックを作る」機能を使って自由に定義できます。
AIは関数の名前と引数の名前、それらにつけられたコメントを元に、関数の動作を理解します。
定義されたすべてのユーザー定義ブロックが、AIが呼び出せる関数として認識されます。
以下の手順で関数を定義できます。

1. 「ブロックを作る」でカスタムブロックを作成します
2. ブロック名と引数を設定します
3. ブロックの動作をScratchのブロックで実装します

名前だけではAIが関数の動作を理解できないときは、以下の手順でブロック定義と引数に説明を追加します。

   1. ブロック定義にコメントを追加して、関数の機能を説明します
   2. ブロックの引数をコードエリアに出して、引数にコメントを追加して、引数の役割を説明します

### 関数の結果を返す

AIが関数を呼び出した後、その結果をAIに返すには ```AIに結果(結果)を返す``` ブロックを使用します。これにより、AIは関数の実行結果を受け取って、次の処理を決定できます。

### 関数呼び出しの制御

```関数呼び出しを(設定)``` ブロックで、AIの関数呼び出し動作を設定できます。

```(設定)``` には、以下の指定ができます。
- ```使う``` - AIが必要に応じて関数を呼び出す（デフォルト）
- ```いつも使う``` - AIに関数呼び出しを強制する
- ```使わない``` - 関数呼び出しを無効にする

### 動作の流れ

1. AIがプロンプトを受け取る
2. 必要に応じて登録された関数を呼び出す
3. 関数の実行結果を受け取る
4. 結果を元に適切な回答を生成する

この機能により、AIがより動的で知的なScratchプロジェクトを作成できるようになります。


## 画像の利用

```生成(プロンプト)``` に ```dataURL``` を使って画像のData URL形式のデータを含む文章を入れて問い合わせることができます。

_※ 現在公開されているGemini pro API v1ではチャットに画像を利用できません。_

Scratch内の画像の ```dataURL``` は、以下のブロックを使って取得することができます。

- ```コスチューム(セレクター)のデータ``` ブロックは、指定されたコスチュームの ```dataURL``` を取得します。```(セレクター)``` には、コスチュームの名前もしくは番号(- は最後からの順番)を指定できます。
- ```バックドロップ(セレクター)のデータ``` ブロックは、背景の ```dataURL``` を取得します。```(セレクター)``` には、背景の名前もしくは番号(- は最後からの順番)を指定できます。
- ```スナップショットのデータ``` ブロックは、ステージと表示されているスプライトのスナップショット画像の ```dataURL``` を取得します。


## 生成されたファイルの取得

一部のAIモデルは、回答の一部として画像や音声などのファイルを生成して返すことができます。これらの生成されたファイルには、以下のブロックを使ってアクセスできます。

- ```(インデックス)番目の生成ファイルのデータ``` ブロックは、指定されたインデックスの生成されたファイルのデータURLを取得します。インデックスは1から始まります。そのインデックスにファイルが存在しない場合は空の文字列を返します。
- ```(インデックス)番目の生成ファイルのメディアタイプ``` ブロックは、指定されたインデックスの生成されたファイルのメディアタイプ（MIMEタイプ）を取得します。そのインデックスにファイルが存在しない場合は空の文字列を返します。
- ```生成ファイルの数``` ブロックは、最後のAI回答で生成されたファイルの総数を返します。ファイルが生成されなかった場合は0を返します。

これらのブロックは、画像や音声ファイル、その他のメディアコンテンツを回答の一部として生成できるAIモデルと組み合わせて使用すると便利です。


## 安全性の設定

_※ 安全性の設定機能は現在非推奨となっています。この機能はGemini APIでのみ利用可能でしたが、複数のAIプロバイダーをサポートするため削除されました。_


## 生成パラメータの設定

AIが利用する生成モデルのパラメータの設定は、スプライト毎に別々に設定できます。

パラメータの設定は、```生成の(パラメータ)を( )にする``` ブロックを使用します。

```(パラメータ)```には、以下の指定ができます。

- ```温度```
- ```Top P```
- ```Top K```
- ```最大トークン数```
- ```ストップシーケンス```
- ```システム インストラクション```
- ```レスポンス スキーマ```

_※ ```回答候補の数``` パラメータは削除されました。複数のAIプロバイダーをサポートするため、このパラメータは利用できなくなりました。_

```( )``` には、設定する値を指定します。

```生成の(パラメータ)``` ブロックは、そのスプライトの利用する生成モデルのパラメータを取得します。


## 構造化出力（Response Schema）

AIに対して、特定の形式（JSON形式）で回答を生成させることができます。これにより、プログラムで処理しやすい構造化されたデータを取得できます。

### 使用方法

1. ```生成の(レスポンス スキーマ)を( )にする``` ブロックを使用して、JSONスキーマを設定します
2. ```生成(プロンプト)``` または ```チャット(プロンプト)``` ブロックを実行します
3. AIはスキーマに従った形式でJSON回答を生成します

### JSONスキーマの書き方

JSONスキーマは、期待する回答の構造を定義します。以下は基本的な例です：

```json
{
  "type": "object",
  "properties": {
    "name": {
      "type": "string",
      "description": "人物の名前"
    },
    "age": {
      "type": "number",
      "description": "年齢"
    },
    "skills": {
      "type": "array",
      "items": {
        "type": "string"
      },
      "description": "スキルのリスト"
    }
  },
  "required": ["name", "age"]
}
```

### JSONデータの処理

生成されたJSON形式の回答は、以下のブロックで処理できます：

- ```JSONの(パス)から( )を取得``` ブロック - JSONオブジェクトから特定の値を取得
- ```JSON配列の(インデックス)番目の( )``` ブロック - JSON配列から特定の要素を取得
- ```JSON配列の( )の長さ``` ブロック - JSON配列の要素数を取得

### 実用例

例えば、「3人のキャラクターを作成して」というプロンプトに対して、以下のようなスキーマを設定すると：

```json
{
  "type": "object",
  "properties": {
    "characters": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "name": {"type": "string"},
          "role": {"type": "string"},
          "description": {"type": "string"}
        }
      }
    }
  }
}
```

AIは以下のような構造化された回答を生成します：

```json
{
  "characters": [
    {
      "name": "勇者アレックス",
      "role": "戦士",
      "description": "正義感が強く、仲間を守る盾となる"
    },
    {
      "name": "魔法使いルナ",
      "role": "魔法使い",
      "description": "古代魔法に精通した賢者"
    },
    {
      "name": "盗賊ジン",
      "role": "盗賊",
      "description": "素早い動きと器用さが武器"
    }
  ]
}
```

### 注意事項

- レスポンススキーマを設定すると、AIは必ずJSON形式で回答します
- スキーマの設定を解除するには、空の値を設定します
- 対応していないAIプロバイダーでは、この機能が利用できない場合があります


## エンベディング

```( )のエンベディング``` ブロックは、入力された文に対して埋め込み表現を取得します。

_※ タスクタイプの指定機能は削除されました。複数のAIプロバイダーをサポートするため、タスクタイプを指定せずに汎用的な埋め込み表現を取得するようになりました。_

埋め込み表現は、```(ベクトルA)と(ベクトルB)の(計算方法)``` ブロックを使って類似度を計算することができます。ベクトルAとベクトルBは、```( )のエンベディング``` ブロックで取得した埋め込み表現を指定します。

 ```(計算方法)``` には、```内積```、```コサイン距離``` もしくは ```ユークリッド距離``` を指定できます。

埋め込み表現に利用するモデルを指定するには、```( )のエンベディング``` ブロックを実行する前に ```モデルに(モデル名)を使う``` ブロックを使用します。```(モデル名)``` には、使用するAIプロバイダーで利用可能な埋め込みモデルのモデルコードを指定します。
